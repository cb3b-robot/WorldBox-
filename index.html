<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WorldBox World — All Countries, Zoom & Humans</title>

<!-- D3 + PapaParse (for map + CSV parsing) -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root {
    --bg: #020617;
    --panel: #020617;
    --accent: #38bdf8;
    --accent-soft: rgba(56,189,248,0.16);
    --muted: #9ca3af;
    --text: #e5e7eb;
  }
  * { box-sizing:border-box; }
  html, body {
    margin:0; padding:0;
    width:100%; height:100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top,#0f172a 0%,#020617 55%);
    color:var(--text);
  }
  .page {
    display:flex;
    flex-direction:row;
    height:100vh;
    padding:8px;
    gap:8px;
  }
  @media (max-width: 900px) {
    .page { flex-direction:column; }
  }
  .left {
    flex:3;
    background: radial-gradient(circle at top,#0b1120 0%,#020617 70%);
    border-radius:10px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    box-shadow:0 18px 40px rgba(0,0,0,0.6);
  }
  .right {
    flex:2;
    background: linear-gradient(180deg,#020617,#020617);
    border-radius:10px;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
    box-shadow:0 18px 40px rgba(0,0,0,0.65);
  }
  header {
    display:flex;
    align-items:center;
    gap:8px;
  }
  header h1 {
    margin:0;
    font-size:18px;
    letter-spacing:0.03em;
  }
  .badge {
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(56,189,248,0.6);
    background:rgba(8,47,73,0.8);
    color:#7dd3fc;
  }
  .sub {
    margin-left:auto;
    font-size:12px;
    color:var(--muted);
  }
  #mapWrap {
    flex:1;
    border-radius:8px;
    overflow:hidden;
    position:relative;
    background: radial-gradient(circle at top,#0ea5e9,#0369a1 45%,#0f172a 100%);
    border:1px solid rgba(15,23,42,0.9);
  }
  svg#worldSvg {
    width:100%;
    height:100%;
    display:block;
    touch-action:none; /* for D3 zoom on touch */
  }
  .overlay-note {
    position:absolute;
    left:8px; top:8px;
    background:rgba(15,23,42,0.9);
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    color:var(--muted);
    border:1px solid rgba(148,163,184,0.35);
  }
  .bottom-bar {
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:4px;
    flex-wrap:wrap;
  }
  .pill {
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
  }
  #status {
    margin-left:auto;
    font-size:12px;
    color:var(--muted);
  }
  .panel-title {
    font-size:14px;
    font-weight:600;
  }
  .small {
    font-size:12px;
    color:var(--muted);
  }
  .info-box {
    background:rgba(15,23,42,0.95);
    border-radius:8px;
    padding:8px;
    border:1px solid rgba(148,163,184,0.35);
  }
  .info-row {
    display:flex;
    justify-content:space-between;
    font-size:12px;
    margin-top:4px;
  }
  .info-row span.label { color:var(--muted); }
  .info-row span.value { font-weight:500; }
  .bar-bg {
    width:100%;
    height:6px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    margin-top:6px;
    overflow:hidden;
    position:relative;
  }
  .bar-fill {
    position:absolute;
    left:0; top:0; bottom:0;
    border-radius:999px;
    background:linear-gradient(90deg,#22c55e,#38bdf8);
    width:0%;
  }
  .color-dot {
    width:14px;
    height:14px;
    border-radius:4px;
    border:1px solid rgba(148,163,184,0.7);
    margin-right:4px;
  }
  .human-slider {
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  input[type=range] {
    width:100%;
  }
  button {
    border:none;
    border-radius:6px;
    padding:6px 10px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    background:var(--accent);
    color:#020617;
    display:inline-flex;
    align-items:center;
    gap:4px;
    box-shadow:0 8px 22px rgba(56,189,248,0.35);
  }
  button.secondary {
    background:rgba(15,23,42,0.95);
    color:var(--muted);
    border:1px solid rgba(148,163,184,0.35);
    box-shadow:none;
  }
  button:active {
    transform:translateY(1px);
    box-shadow:none;
  }
  .country-list {
    flex:1;
    border-radius:8px;
    padding:6px;
    overflow:auto;
    background:radial-gradient(circle at top,#020617,#020617 60%);
    border:1px solid rgba(15,23,42,0.9);
  }
  .country-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:12px;
    padding:4px 6px;
    border-radius:6px;
    cursor:pointer;
    margin-bottom:2px;
  }
  .country-row:hover {
    background:rgba(15,23,42,0.95);
  }
  .country-row.selected {
    background:var(--accent-soft);
    border:1px solid rgba(56,189,248,0.6);
  }
  .country-row-name {
    display:flex;
    align-items:center;
    gap:4px;
  }
  .country-row-pop {
    color:var(--muted);
    font-size:11px;
  }
  footer {
    font-size:11px;
    color:var(--muted);
    border-top:1px solid rgba(15,23,42,0.9);
    padding-top:4px;
    margin-top:4px;
  }
</style>
</head>
<body>
<div class="page">
  <section class="left">
    <header>
      <h1>WorldBox World</h1>
      <span class="badge">All countries · Zoom & humans</span>
      <div class="sub">1 population unit = 1 million people (rounded up)</div>
    </header>
    <div id="mapWrap">
      <div class="overlay-note">Scroll / pinch to zoom · drag to move · tap a country</div>
      <svg id="worldSvg" viewBox="0 0 1200 600" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <div class="bottom-bar">
      <div class="pill">Hover / tap: see name & population</div>
      <div class="pill">When zoomed in and a country is selected, human dots appear</div>
      <div id="status">Loading data…</div>
    </div>
  </section>

  <aside class="right">
    <div>
      <div class="panel-title">Selected country</div>
      <div class="info-box">
        <div style="display:flex;align-items:center;gap:6px;">
          <div id="infoColorDot" class="color-dot" style="background:#020617;"></div>
          <div>
            <div id="infoName" style="font-size:13px;font-weight:600;">None</div>
            <div id="infoRegion" class="small">Tap a country on the map.</div>
          </div>
        </div>
        <div class="info-row">
          <span class="label">Population (millions)</span>
          <span class="value" id="infoPopMillions">—</span>
        </div>
        <div class="info-row">
          <span class="label">Population units</span>
          <span class="value" id="infoPopUnits">—</span>
        </div>
        <div class="info-row">
          <span class="label">Humans drawn</span>
          <span class="value" id="infoDots">—</span>
        </div>
        <div class="bar-bg">
          <div class="bar-fill" id="infoBar"></div>
        </div>
      </div>
      <div class="small" style="margin-top:4px;">
        Each dot represents a chunk of people (you choose how many millions per dot).
        We can’t show every literal human, or your iPad would explode.
      </div>
    </div>

    <div class="human-slider">
      <div class="panel-title" style="margin-top:6px;">Humans per dot</div>
      <div class="small">Lower = more dots, higher = fewer dots.</div>
      <input type="range" id="humansPerDot" min="1" max="50" value="5" />
      <div class="info-row">
        <span class="label">Millions per dot</span>
        <span class="value" id="humansPerDotLabel">5</span>
      </div>
      <div class="info-row">
        <span class="label">Max dots per country (safety)</span>
        <span class="value">400</span>
      </div>
    </div>

    <div>
      <div class="panel-title" style="margin-top:6px;">Countries (by population)</div>
      <div class="small">Tap to jump to a country and zoom to it.</div>
    </div>
    <div id="countryList" class="country-list"></div>

    <footer>
      To host: put this file in a GitHub repo as <code>index.html</code>, turn on GitHub Pages (branch: main, folder: root), then open the link.
    </footer>
  </aside>
</div>

<script>
(async function() {
  const POP_CSV_URL = "https://datahub.io/core/population/r/population.csv";
  const WORLD_GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json";

  const svg = d3.select("#worldSvg");
  const width = 1200, height = 600;
  const statusEl = document.getElementById("status");
  const countryListEl = document.getElementById("countryList");
  const humansPerDotInput = document.getElementById("humansPerDot");
  const humansPerDotLabel = document.getElementById("humansPerDotLabel");

  // Info UI elements
  const infoName = document.getElementById("infoName");
  const infoRegion = document.getElementById("infoRegion");
  const infoPopMillions = document.getElementById("infoPopMillions");
  const infoPopUnits = document.getElementById("infoPopUnits");
  const infoDots = document.getElementById("infoDots");
  const infoBar = document.getElementById("infoBar");
  const infoColorDot = document.getElementById("infoColorDot");

  humansPerDotInput.addEventListener("input", () => {
    humansPerDotLabel.textContent = humansPerDotInput.value;
    drawHumansForSelected(); // update dots based on new slider value
  });

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  setStatus("Downloading population CSV…");

  // Fetch population CSV
  const popResp = await fetch(POP_CSV_URL);
  const popText = await popResp.text();
  const popParsed = Papa.parse(popText, {header:true, dynamicTyping:true});
  const popData = popParsed.data.filter(d => d && d["Country Name"] && d.Year && d.Value != null);

  // Build pop map by country name + latest year
  const popMap = new Map();
  for (const row of popData) {
    const name = row["Country Name"].trim();
    const year = +row.Year;
    const val = +row.Value;
    if (!popMap.has(name)) {
      popMap.set(name, {latestYear: year, latestValue: val, byYear: {[year]:val}});
    } else {
      const obj = popMap.get(name);
      obj.byYear[year] = val;
      if (year > obj.latestYear) {
        obj.latestYear = year;
        obj.latestValue = val;
      }
    }
  }

  setStatus("Downloading world GeoJSON…");
  const geoResp = await fetch(WORLD_GEOJSON_URL);
  const geojson = await geoResp.json();

  setStatus("Building world…");

  const projection = d3.geoNaturalEarth1()
    .fitSize([width, height], geojson);

  const path = d3.geoPath().projection(projection);

  // Build countries array with population
  const countries = geojson.features.map((f, idx) => {
    const props = f.properties || {};
    const name = props.name || props.ADMIN || props.admin || f.id || ("Country " + idx);
    const regionGuess = props.region || props.region_un || props.continent || "Unknown region";

    // population match
    const popEntry = findPopulationEntry(name);
    const popMillions = popEntry ? (popEntry.latestValue / 1_000_000) : null;
    const popUnits = popMillions != null ? Math.ceil(popMillions) : null;

    const centroid = path.centroid(f);
    const bounds = path.bounds(f); // [[x0,y0],[x1,y1]]

    return {
      id: props.iso_a3 || props.ISO_A3 || f.id || name,
      name,
      region: regionGuess,
      feature: f,
      centroid,
      bounds,
      populationRaw: popEntry ? popEntry.latestValue : null,
      populationMillions: popMillions,
      populationUnits: popUnits
    };
  });

  function findPopulationEntry(countryName) {
    // exact match
    if (popMap.has(countryName)) return popMap.get(countryName);
    // some common aliases
    const aliases = {
      "United States of America":"United States",
      "Democratic Republic of the Congo":"Congo, Dem. Rep.",
      "Republic of the Congo":"Congo, Rep.",
      "Russian Federation":"Russian Federation",
      "Bolivia":"Bolivia (Plurinational State of)",
      "Iran":"Iran, Islamic Rep.",
      "Egypt":"Egypt, Arab Rep.",
      "Venezuela":"Venezuela, RB",
      "Syria":"Syrian Arab Republic",
      "Bahamas":"Bahamas, The",
      "Gambia":"Gambia, The",
      "Yemen":"Yemen, Rep.",
      "Czechia":"Czech Republic",
      "Eswatini":"Swaziland",
      "North Macedonia":"Macedonia, FYR",
      "Cape Verde":"Cabo Verde",
      "Micronesia":"Micronesia, Fed. Sts.",
      "Kyrgyzstan":"Kyrgyz Republic",
      "Slovakia":"Slovak Republic"
    };
    if (aliases[countryName] && popMap.has(aliases[countryName])) {
      return popMap.get(aliases[countryName]);
    }
    // loose match: try contains
    const target = countryName.toLowerCase();
    let best = null;
    let bestScore = 0;
    for (const [name, entry] of popMap.entries()) {
      const l = name.toLowerCase();
      let score = 0;
      if (l === target) score = 3;
      else if (l.includes(target) || target.includes(l)) score = 2;
      else if (l.split(" ")[0] === target.split(" ")[0]) score = 1;
      if (score > bestScore) {
        bestScore = score;
        best = entry;
      }
    }
    if (bestScore >= 2) return best;
    return null;
  }

  // Find max popUnits for relative bar
  let maxUnits = 0;
  countries.forEach(c => {
    if (c.populationUnits && c.populationUnits > maxUnits) {
      maxUnits = c.populationUnits;
    }
  });

  // Build scales
  const colorScale = d3.scaleSequential(d3.interpolateYlGnBu)
    .domain([0, d3.max(countries, d => d.populationMillions || 0) || 1]);

  // SVG groups
  svg.attr("width", width).attr("height", height);
  const root = svg.append("g").attr("class","root");
  const countryGroup = root.append("g").attr("class","countries");
  const humansGroup = root.append("g").attr("class","humans").attr("opacity",0.95);

  // Draw countries
  const countryPaths = countryGroup
    .selectAll("path.country")
    .data(countries, d => d.id)
    .enter()
    .append("path")
    .attr("class","country")
    .attr("d", d => path(d.feature))
    .attr("fill", d => {
      if (!d.populationMillions) return "#0b3b58";
      return colorScale(d.populationMillions);
    })
    .attr("stroke","#020617")
    .attr("stroke-width",0.4)
    .attr("vector-effect","non-scaling-stroke")
    .style("cursor","pointer");

  // Simple hover tooltip
  const tooltip = d3.select("body").append("div")
    .style("position","absolute")
    .style("pointer-events","none")
    .style("background","rgba(15,23,42,0.95)")
    .style("border","1px solid rgba(148,163,184,0.6)")
    .style("border-radius","6px")
    .style("padding","6px 8px")
    .style("font-size","12px")
    .style("color","#e5e7eb")
    .style("box-shadow","0 12px 32px rgba(0,0,0,0.4)")
    .style("display","none");

  function showTooltip(event, d) {
    const popText = d.populationMillions != null
      ? `${d.populationMillions.toFixed(1)}M (units: ${d.populationUnits})`
      : "unknown";
    tooltip
      .style("display","block")
      .html(`<strong>${d.name}</strong><br><span style="color:#9ca3af;">Population:</span> ${popText}`)
      .style("left", (event.pageX + 10) + "px")
      .style("top", (event.pageY + 10) + "px");
  }
  function hideTooltip() {
    tooltip.style("display","none");
  }

  countryPaths
    .on("mouseover", function(event,d){
      d3.select(this).attr("stroke","#0f172a").attr("stroke-width",1.1);
      showTooltip(event,d);
    })
    .on("mousemove", showTooltip)
    .on("mouseout", function(event,d){
      d3.select(this).attr("stroke","#020617").attr("stroke-width",0.4);
      hideTooltip();
    });

  let selectedCountry = null;

  countryPaths.on("click", function(event, d) {
    selectedCountry = d;
    updateInfoPanel();
    zoomToCountry(d);
    drawHumansForSelected();
    updateCountryListHighlight();
  });

  // Zoom / pan
  const zoom = d3.zoom()
    .scaleExtent([1, 30])
    .on("zoom", (event) => {
      root.attr("transform", event.transform);
      // If zoomed out too far, hide humans
      const k = event.transform.k;
      if (k < 3) {
        humansGroup.attr("display","none");
      } else {
        humansGroup.attr("display", selectedCountry ? null : "none");
      }
    });

  svg.call(zoom);

  function zoomToCountry(c) {
    const [[x0, y0], [x1, y1]] = path.bounds(c.feature);
    const dx = x1 - x0;
    const dy = y1 - y0;
    const cx = (x0 + x1) / 2;
    const cy = (y0 + y1) / 2;
    const scale = Math.max(1, Math.min(24, 0.9 / Math.max(dx / width, dy / height)));
    const translate = [width / 2 - scale * cx, height / 2 - scale * cy];
    svg.transition().duration(800).call(
      zoom.transform,
      d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
    );
  }

  function updateInfoPanel() {
    if (!selectedCountry) {
      infoName.textContent = "None";
      infoRegion.textContent = "Tap a country on the map.";
      infoPopMillions.textContent = "—";
      infoPopUnits.textContent = "—";
      infoDots.textContent = "—";
      infoBar.style.width = "0%";
      infoColorDot.style.background = "#020617";
      return;
    }
    const c = selectedCountry;
    infoName.textContent = c.name;
    infoRegion.textContent = c.region;
    if (c.populationMillions != null) {
      infoPopMillions.textContent = c.populationMillions.toFixed(1);
      infoPopUnits.textContent = c.populationUnits + "";
      const rel = maxUnits ? Math.round((c.populationUnits / maxUnits) * 100) : 0;
      infoBar.style.width = rel + "%";
    } else {
      infoPopMillions.textContent = "unknown";
      infoPopUnits.textContent = "unknown";
      infoBar.style.width = "0%";
    }
    // color sample
    const fill = (c.populationMillions != null) ? colorScale(c.populationMillions) : "#0b3b58";
    infoColorDot.style.background = fill;

    const dots = humansGroup.selectAll("circle").size();
    infoDots.textContent = dots ? dots : "0";
  }

  function updateCountryListHighlight() {
    const rows = countryListEl.querySelectorAll(".country-row");
    rows.forEach(row => {
      if (selectedCountry && row.dataset.id === selectedCountry.id) {
        row.classList.add("selected");
      } else {
        row.classList.remove("selected");
      }
    });
  }

  // Build country list (sorted by population)
  const sortedCountries = countries.slice().sort((a,b) => (b.populationMillions || 0) - (a.populationMillions || 0));
  countryListEl.innerHTML = "";
  sortedCountries.forEach(c => {
    const row = document.createElement("div");
    row.className = "country-row";
    row.dataset.id = c.id;

    const nameDiv = document.createElement("div");
    nameDiv.className = "country-row-name";

    const colorDot = document.createElement("div");
    colorDot.className = "color-dot";
    const fill = (c.populationMillions != null) ? colorScale(c.populationMillions) : "#0b3b58";
    colorDot.style.background = fill;

    const nameSpan = document.createElement("span");
    nameSpan.textContent = c.name;

    nameDiv.appendChild(colorDot);
    nameDiv.appendChild(nameSpan);

    const popSpan = document.createElement("div");
    popSpan.className = "country-row-pop";
    if (c.populationMillions != null) {
      popSpan.textContent = c.populationMillions.toFixed(1) + "M";
    } else {
      popSpan.textContent = "unknown";
    }

    row.appendChild(nameDiv);
    row.appendChild(popSpan);

    row.addEventListener("click", () => {
      selectedCountry = c;
      updateInfoPanel();
      zoomToCountry(c);
      drawHumansForSelected();
      updateCountryListHighlight();
    });

    countryListEl.appendChild(row);
  });

  // --- HUMAN DOTS ---
  function drawHumansForSelected() {
    humansGroup.selectAll("*").remove();
    if (!selectedCountry || !selectedCountry.populationMillions) {
      updateInfoPanel();
      return;
    }

    const millionsPerDot = parseFloat(humansPerDotInput.value) || 1;
    humansPerDotLabel.textContent = millionsPerDot;
    let dotCount = Math.ceil(selectedCountry.populationMillions / millionsPerDot);
    const MAX_DOTS = 400;
    if (dotCount > MAX_DOTS) dotCount = MAX_DOTS;

    // If zoom is very far out, don't draw
    const currentTransform = d3.zoomTransform(svg.node());
    if (currentTransform.k < 3) {
      humansGroup.attr("display","none");
      updateInfoPanel();
      return;
    } else {
      humansGroup.attr("display", null);
    }

    // Sample random points inside the country polygon
    const feature = selectedCountry.feature;
    const bounds = d3.geoBounds(feature); // [[minLon,minLat],[maxLon,maxLat]]
    const [minLon, minLat] = bounds[0];
    const [maxLon, maxLat] = bounds[1];

    const points = [];
    let tries = 0;
    const MAX_TRIES = dotCount * 30;

    while (points.length < dotCount && tries < MAX_TRIES) {
      tries++;
      const lon = minLon + Math.random() * (maxLon - minLon);
      const lat = minLat + Math.random() * (maxLat - minLat);
      if (d3.geoContains(feature, [lon, lat])) {
        const [x, y] = projection([lon, lat]);
        points.push([x, y]);
      }
    }

    humansGroup
      .selectAll("circle")
      .data(points)
      .enter()
      .append("circle")
      .attr("cx", d => d[0])
      .attr("cy", d => d[1])
      .attr("r", 1.2)
      .attr("fill", "#f9fafb")
      .attr("stroke", "#0f172a")
      .attr("stroke-width", 0.3)
      .attr("vector-effect","non-scaling-stroke");

    updateInfoPanel();
  }

  setStatus("Ready. Tap a country, then zoom in to see humans.");
})();
</script>
</body>
</html>
